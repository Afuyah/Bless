<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Nawiri Enterprise - Professional POS System">
    <meta name="theme-color" content="#2563eb">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="csrf-token" content="{{ csrf_token() }}">

    <title>{% block title %}Nawiri POS{% endblock %}</title>
    
    <!-- Preload Tailwind CSS -->
    <link rel="preload" href="{{ url_for('static', filename='css/tailwind.css') }}" as="style">
    
    <!-- Favicon & PWA Assets -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/icon-192x192.png') }}">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Critical CSS (prevents FOUC) -->
    <style>
        /* Basic layout styles to prevent FOUC */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
            color: #1e293b;
        }
        .sidebar {
            background: linear-gradient(to bottom, #1e40af, #1e3a8a);
            color: white;
        }
        /* Hide content until Tailwind loads */
        [x-cloak] { display: none !important; }
    </style>

    <!-- Load Tailwind CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/tailwind.css') }}"></noscript>

    <!-- Custom Styles -->
    <style>
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 3px;
        }
        ::-webkit-scrollbar-track {
            background-color: rgba(243, 244, 246, 0.5);
        }
        
        /* Smooth transitions */
        .transition-all-slow {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Product card hover effect */
        .product-card {
            transition: all 0.2s ease, transform 0.1s ease;
        }
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.08);
        }
        .product-card:active {
            transform: translateY(0);
        }

        /* Light color scheme adjustments */
        .pos-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        .pos-card:hover {
            border-color: #93c5fd;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* Image container */
        .pos-card .relative.aspect-\[1\/1\] {
            background-color: white;
            border-bottom: 1px solid #f3f4f6;
        }
        
        /* Modal backdrop */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        /* Button press effect */
        .btn-press:active {
            transform: scale(0.98);
        }
        
        /* Fade in animation */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* Pulse animation */
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Sidebar styles */
        .sidebar {
            background: linear-gradient(to bottom, #1e40af, #1e3a8a);
            color: white;
        }
        .sidebar a, .sidebar button {
            color: white;
        }
        .sidebar a:hover, .sidebar button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .sidebar .active {
            background-color: rgba(255, 255, 255, 0.2);
        }

        /* Print styles */
        .receipt-print {
            display: none;
        }
        @media print {
            .receipt-print {
                display: block;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>

<body class="font-sans bg-gray-50 text-gray-800 antialiased" x-data="{ sidebarOpen: window.innerWidth >= 768 }" x-cloak>
    <!-- App Container -->
    <div class="flex h-screen">
        <!-- Sidebar -->
        <div class="sidebar w-16 md:w-64 flex-shrink-0 flex flex-col transition-all duration-300 ease-in-out"
             :class="sidebarOpen ? 'w-64' : 'w-16'">
            
            <!-- Sidebar Header -->
            <div class="p-4 border-b border-blue-700 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="bg-white/10 p-2 rounded-lg flex items-center justify-center">
                        <i class="fas fa-store text-lg text-blue-200"></i>
                    </div>
                    <div class="min-w-0" :class="sidebarOpen ? 'block' : 'hidden'">
                        <h1 class="text-lg font-semibold truncate">Nawiri POS</h1>
                        <p class="text-blue-200 text-sm truncate">
                            Cashier: {{ current_user.username if current_user else 'Guest' }}
                        </p>
                    </div>
                </div>
                <button @click="sidebarOpen = !sidebarOpen" class="hidden md:block text-blue-200 hover:text-white">
                    <i class="fas" :class="sidebarOpen ? 'fa-chevron-left' : 'fa-chevron-right'"></i>
                </button>
            </div>

            <!-- Sidebar Navigation -->
            <nav class="flex-1 overflow-y-auto p-4 space-y-6">
                <!-- Register Section -->
                <div>
                    <h2 class="text-blue-300 uppercase text-xs font-bold mb-2 tracking-wider" :class="sidebarOpen ? 'block' : 'hidden'">
                        Register
                    </h2>
                    <ul class="space-y-1">
                        <li>
                            <button class="w-full text-left py-2 px-3 rounded-lg hover:bg-blue-700/50 transition-all flex items-center btn-press">
                                <i class="fas fa-cash-register text-blue-300 w-5 text-center"></i>
                                <span class="truncate" :class="sidebarOpen ? 'ml-3 block' : 'hidden'">Open Register</span>
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- POS Section -->
                <div>
                    <h2 class="text-blue-300 uppercase text-xs font-bold mb-2 tracking-wider" :class="sidebarOpen ? 'block' : 'hidden'">
                        POS
                    </h2>
                    <ul class="space-y-1">
                        <li>
                            <a href="#" class="w-full text-left py-2 px-3 rounded-lg bg-blue-700/30 flex items-center btn-press">
                                <i class="fas fa-shopping-cart text-blue-300 w-5 text-center"></i>
                                <span class="truncate" :class="sidebarOpen ? 'ml-3 block' : 'hidden'">New Sale</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </nav>

            <!-- Sidebar Footer -->
            <div class="p-4 border-t border-blue-700">
                <a href="{{ url_for('auth.logout') }}" class="w-full text-left py-2 px-3 rounded-lg hover:bg-blue-700/50 transition-all flex items-center btn-press">
                    <i class="fas fa-sign-out-alt text-blue-300 w-5 text-center"></i>
                    <span class="truncate" :class="sidebarOpen ? 'ml-3 block' : 'hidden'">Logout</span>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Bar -->
            <header class="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <button @click="sidebarOpen = !sidebarOpen" class="text-gray-500 hover:text-blue-600 transition-all btn-press md:hidden">
                        <i class="fas fa-bars text-lg"></i>
                    </button>

                    <!-- Register Status -->
                    <div class="flex items-center space-x-2 px-3 py-1.5 rounded-full bg-gray-100 text-sm font-medium">
                        <span class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse"></span>
                        <span>Register Closed</span>
                    </div>
                </div>

                <div class="flex items-center space-x-4">
                    <!-- Notifications -->
                    <div class="relative">
                        <button class="text-gray-500 hover:text-blue-600 transition-all btn-press relative">
                            <i class="fas fa-bell text-lg"></i>
                            <span class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs animate-pulse">3</span>
                        </button>
                    </div>

                    <!-- User Profile -->
                    <div class="flex items-center space-x-2">
                        <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-medium shadow-sm">
                            {{ current_user.username[0]|upper if current_user else 'G' }}
                        </div>
                        <span class="hidden md:inline text-sm font-medium">{{ current_user.username if current_user else 'Guest' }}</span>
                    </div>
                </div>
            </header>

            <!-- Main Content Area -->
            <main class="flex-1 overflow-y-auto bg-gray-50">
                {% block content %}
                <!-- Content will be injected here -->
                {% endblock %}
            </main>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 space-y-2 z-50 w-80"></div>

    <!-- Alpine.js for interactivity -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>

    <!-- Scripts -->
    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
                    .then(registration => {
                        console.log('ServiceWorker registered:', registration.scope);
                        registration.onupdatefound = () => {
                            const installingWorker = registration.installing;
                            installingWorker.onstatechange = () => {
                                if (installingWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showToast({
                                        message: 'New version available. Click to refresh!',
                                        type: 'info',
                                        action: () => window.location.reload()
                                    });
                                }
                            };
                        };
                    })
                    .catch(error => console.error('ServiceWorker registration failed:', error));
            });
        }

        // Toast Notification System
        function showToast({message, type = 'info', action = null, duration = 5000}) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            // Type-based styling
            const typeStyles = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            toast.className = `animate-fade-in p-4 rounded-lg shadow-lg text-white flex items-start ${typeStyles[type] || typeStyles.info}`;
            toast.innerHTML = `
                <div class="flex-1">
                    <div class="flex items-center">
                        <i class="fas ${type === 'success' ? 'fa-check-circle' : 
                                          type === 'error' ? 'fa-exclamation-circle' : 
                                          type === 'warning' ? 'fa-exclamation-triangle' : 
                                          'fa-info-circle'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                </div>
                <button class="ml-4 text-white opacity-70 hover:opacity-100">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            // Add click handler if action provided
            if (action) {
                toast.style.cursor = 'pointer';
                toast.addEventListener('click', action);
            }
            
            // Close button
            toast.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                toast.remove();
            });
            
            // Auto-dismiss
            if (duration > 0) {
                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => toast.remove(), 300);
                }, duration);
            }
            
            container.appendChild(toast);
            
            // Return dismiss function
            return {
                dismiss: () => toast.remove()
            };
        }

        // Make toast function globally available
        window.showToast = showToast;

        // Convert Flask flash messages to toasts
        document.addEventListener('DOMContentLoaded', () => {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        showToast({
                            message: "{{ message }}",
                            type: "{{ category }}"
                        });
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });

        // Fallback for Tailwind CSS if it fails to load
        setTimeout(() => {
            if (!document.querySelector('link[href*="tailwind.css"]').sheet) {
                console.log('Tailwind CSS failed to load, loading fallback');
                const fallback = document.createElement('link');
                fallback.rel = 'stylesheet';
                fallback.href = 'https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css';
                document.head.appendChild(fallback);
            }
        }, 1000);
    </script>
</body>
</html>