<!DOCTYPE html>
<html lang="en" class="h-full" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Bhapos - Advanced POS Management System">
    <meta name="keywords" content="POS, Dashboard, Sales, Inventory, Management">
    <title>Bhapos Dashboard</title>
    
    <!-- Critical CSS Inlined to prevent FOUC -->
    <style id="critical-css">
        /* Critical styles to prevent layout shift and FOUC */
        :root {
            --color-primary-500: #0ea5e9;
            --color-primary-400: #38bdf8;
            --color-gray-50: #f8fafc;
            --color-gray-900: #0f172a;
            --color-gray-200: #e2e8f0;
            --color-gray-700: #334155;
            --color-blue-600: #0284c7;
            --color-blue-400: #60a5fa;
        }
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        body {
            background-color: var(--color-gray-50);
            color: var(--color-gray-900);
        }
        
        body.dark {
            background-color: var(--color-gray-900);
            color: var(--color-gray-50);
        }
        
        /* Preloader styles */
        #page-preloader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        body.dark #page-preloader {
            background: var(--color-gray-900);
        }
        
        .preloader-logo {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
            position: relative;
        }
        
        .preloader-logo-inner {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid transparent;
            border-top-color: var(--color-primary-500);
            animation: spin 1.5s linear infinite;
        }
        
        .preloader-logo-inner:nth-child(2) {
            border-top-color: var(--color-primary-400);
            animation-delay: 0.2s;
            width: 70%;
            height: 70%;
            top: 15%;
            left: 15%;
        }
        
        .preloader-progress {
            width: 200px;
            height: 4px;
            background: rgba(14, 165, 233, 0.2);
            border-radius: 2px;
            margin-top: 1.5rem;
            overflow: hidden;
        }
        
        .preloader-progress-bar {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, var(--color-primary-500), var(--color-primary-400));
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        body.dark .preloader-progress {
            background: rgba(125, 211, 252, 0.2);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- Preload important resources -->
    <link rel="preload" href="{{ url_for('static', filename='js/tailwind.js') }}" as="script">
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://unpkg.com/htmx.org@1.9.2" as="script">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style">
    
    <!-- Non-critical CSS (loaded after page load) -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="print" onload="this.media='all'">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" media="print" onload="this.media='all'">
    
    <noscript>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    </noscript>
</head>

<body class="h-full">
    <!-- Enhanced Preloader with better animations and progress tracking -->
    <div id="page-preloader" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-white dark:bg-gray-900">
        <div class="preloader-logo">
            <div class="preloader-logo-inner"></div>
            <div class="preloader-logo-inner"></div>
        </div>
        
        <div class="text-lg font-medium text-gray-700 dark:text-gray-200 mb-2">
            Loading <span class="text-primary-500 dark:text-primary-400 font-semibold">Bhapos</span>
        </div>
        
        <div class="preloader-progress">
            <div id="preloader-progress-bar" class="preloader-progress-bar"></div>
        </div>
    </div>

    <!-- Main Content (hidden until page fully loaded) -->
    <div id="app-content" class="h-full opacity-0">
        {% include 'admin/partials/header.html' %}
        
        <!-- Main Content Area -->
        <div class="flex-1 flex overflow-hidden">
            <div class="flex-1 flex overflow-hidden">
                {% block content %}
                <!-- Page-specific content -->
                {% endblock %}
            </div>
        </div>

        <!-- Toast Container -->
        <div id="toast-container" class="fixed top-4 right-4 z-50 w-80 space-y-2"></div>
    </div>

    <!-- Scripts with proper loading order -->
    <script>
        // Immediately set theme to prevent FOUC
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        document.documentElement.classList.toggle('dark', savedTheme === 'dark');
    </script>

    <!-- Load Tailwind and HTMX -->
    <script src="{{ url_for('static', filename='js/tailwind.js') }}"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.2"></script>

    <!-- Configure Tailwind -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                        },
                        secondary: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>

    <!-- Additional scripts (loaded after main content) -->
    {% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="{{ url_for('static', filename='js/admindash.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    {% endblock %}

    <!-- Page Initialization Script -->
    <script>
        // Enhanced loading sequence
        document.addEventListener('DOMContentLoaded', function() {
            // Start progress simulation
            simulateProgress();
            
            // Prevent scrolling during load
            document.body.style.overflow = 'hidden';
            
            // Initialize theme
            initTheme();
        });

        // Simulate loading progress with realistic curve
        function simulateProgress() {
            const progressBar = document.getElementById('preloader-progress-bar');
            let progress = 0;
            let speed = 0.5;
            
            const animate = () => {
                // Accelerate quickly at first, then slow down
                speed = Math.max(0.1, speed * 0.95);
                progress = Math.min(progress + speed, 100);
                progressBar.style.width = progress + '%';
                
                if (progress < 100) {
                    requestAnimationFrame(animate);
                } else {
                    // When simulated progress completes, wait for window load
                    if (document.readyState === 'complete') {
                        hidePreloader();
                    } else {
                        window.addEventListener('load', hidePreloader);
                    }
                }
            };
            
            requestAnimationFrame(animate);
        }

        // Hide preloader and show content
        function hidePreloader() {
            const preloader = document.getElementById('page-preloader');
            const appContent = document.getElementById('app-content');
            
            // Complete the progress bar
            document.getElementById('preloader-progress-bar').style.width = '100%';
            
            // Fade out preloader
            preloader.style.opacity = '0';
            preloader.style.pointerEvents = 'none';
            
            // Fade in main content
            appContent.style.opacity = '1';
            appContent.style.transition = 'opacity 0.3s ease';
            
            // Restore scrolling
            document.body.style.overflow = '';
            
            // Remove preloader from DOM after animation
            setTimeout(() => {
                preloader.remove();
                initApp();
            }, 500);
        }

        // Initialize application after load
        function initApp() {
            // Initialize sidebar and other UI components
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const sidebarCollapse = document.getElementById('sidebar-collapse');
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            
            if (mobileMenuButton && sidebar) {
                mobileMenuButton.addEventListener('click', () => {
                    sidebar.classList.toggle('-translate-x-full');
                    if (sidebarOverlay) {
                        sidebarOverlay.classList.toggle('opacity-0');
                        sidebarOverlay.classList.toggle('pointer-events-none');
                    }
                    document.body.style.overflow = sidebar.classList.contains('-translate-x-full') ? '' : 'hidden';
                });
            }
            
            if (sidebarOverlay) {
                sidebarOverlay.addEventListener('click', () => {
                    sidebar.classList.add('-translate-x-full');
                    sidebarOverlay.classList.add('opacity-0', 'pointer-events-none');
                    document.body.style.overflow = '';
                });
            }
            
            if (sidebarCollapse) {
                sidebarCollapse.addEventListener('click', function() {
                    sidebar.classList.toggle('w-72');
                    sidebar.classList.toggle('w-20');
                    document.querySelectorAll('.nav-item span').forEach(el => {
                        el.classList.toggle('hidden');
                    });
                    sidebarCollapse.querySelector('svg').classList.toggle('rotate-180');
                });
            }
            
            // Set active nav items
            setActiveNav();
            
            // Handle HTMX events
            document.addEventListener('htmx:afterSwap', setActiveNav);
            document.addEventListener('htmx:beforeRequest', showLoader);
            document.addEventListener('htmx:afterOnLoad', hideLoader);
        }

        // Initialize theme
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                themeToggle.addEventListener('click', () => {
                    const isDark = document.documentElement.classList.toggle('dark');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
                });
            }
        }

        // Set active navigation item
        function setActiveNav() {
            const currentPath = window.location.pathname;
            document.querySelectorAll('.nav-item').forEach(item => {
                const itemPath = new URL(item.href).pathname;
                const isActive = currentPath === itemPath || 
                                (currentPath.startsWith(itemPath) && itemPath !== '/');
                
                item.classList.toggle('bg-gray-100/50', isActive);
                item.classList.toggle('dark:bg-gray-800/80', isActive);
                item.classList.toggle('text-primary-600', isActive);
                item.classList.toggle('dark:text-primary-400', isActive);
                
                const icon = item.querySelector('i');
                if (icon) {
                    icon.classList.toggle('text-primary-500', isActive);
                    icon.classList.toggle('text-gray-500', !isActive);
                    icon.classList.toggle('dark:text-gray-400', !isActive);
                }
            });
        }

        // Show loader for HTMX requests
        function showLoader() {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.classList.remove('opacity-0', 'pointer-events-none');
                loader.classList.add('opacity-100');
            }
        }

        // Hide loader after HTMX requests complete
        function hideLoader() {
            const loader = document.getElementById('global-loader');
            if (loader) {
                loader.querySelector('div').classList.add('scale-95');
                setTimeout(() => {
                    loader.classList.remove('opacity-100');
                    loader.classList.add('opacity-0', 'pointer-events-none');
                }, 300);
            }
        }

        // Fallback in case something goes wrong
        setTimeout(hidePreloader, 8000);
    </script>
</body>
</html>